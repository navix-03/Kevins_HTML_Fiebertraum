<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <title>Vegetation im Seepark, Lahr</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/gokertanrisever/leaflet-ruler@master/src/leaflet-ruler.css">  
    <script src="https://cdn.jsdelivr.net/gh/gokertanrisever/leaflet-ruler@master/src/leaflet-ruler.js"></script>

    <style>
    html, body, #mapid { 
        width: 100%; 
        height: 100%; 
        padding: 0; 
        margin: 0; 
    }

    .info.legend {
        background: white;
        padding: 12px;
        border: 2px solid #555;
        border-radius: 8px;
        line-height: 24px;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 14px;
        color: #333;
        box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
    }

    .info.legend i {
        width: 20px;
        height: 20px;
        float: left;
        margin-right: 10px;
        border: 1px solid #000;
        opacity: 0.8;
    }
</style>    
</head>
<body>

    <div id="mapid"></div>

    <script>
        // 1. Karte initialisieren
        var mymap = L.map('mapid').setView([48.34, 7.86], 14);

        // 2. Basemaps definieren
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri'
        });

        osm.addTo(mymap);

        // 3. Styling
        function getColor(d) {
            switch (d) {
                case 'pot. Bäume': return '#00441b';
                case 'pot. Hecken und Büsche': return '#238b45';
                case 'pot. Veg': return '#a1d99b';
                default: return '#bdbdbd';
            }
        }

        function styleFunction(feature) {
            return { 
                fillColor: getColor(feature.properties.Class_name), 
                weight: 1, 
                opacity: 1, 
                color: 'white', 
                fillOpacity: 0.8 // Etwas reduziert für bessere Sichtbarkeit beim Messen
            };
        }

        // 4. Das Namens-Mapping
        const namenMapping = {
            "pot. Bäume": "Baum",
            "pot. Hecken und Büsche": "Busch/Hecke",
            "pot. Veg": "Wiese"
        };

        // 5. Die verbesserte Pop-up-Funktion (Fix für Ruler-Tool)
        function popUpFunction(feature, layer) {
            layer.on('click', function(e) {
                var rulerBtn = document.querySelector('.leaflet-ruler');
                var isRulerActive = rulerBtn ? rulerBtn.classList.contains('leaflet-ruler-clicked') : false;

                // WICHTIG: Wenn das Lineal aktiv ist, brechen wir hier ab und lassen 
                // den Klick zur Karte durch (kein stopPropagation!), damit der Messpunkt gesetzt wird.
                if (isRulerActive) {
                    return; 
                }

                // Wenn Lineal inaktiv: Zeige schönes Pop-up
                let technischerName = feature.properties.Class_name;
                let anzeigeName = namenMapping[technischerName] || technischerName;

                L.popup()
                    .setLatLng(e.latlng)
                    .setContent("<b>Klasse:</b> " + anzeigeName)
                    .openOn(mymap);
                
                L.DomEvent.stopPropagation(e);
            });
        }

        // 6. Daten laden
        fetch('Baeume.geojson')
            .then(response => {
                if (!response.ok) throw new Error("Datei 'Baeume.geojson' nicht gefunden.");
                return response.json();
            })
            .then(data => {
                var overlay_baeume = L.geoJSON(data, {
                    style: styleFunction,
                    onEachFeature: popUpFunction
                }).addTo(mymap);

                mymap.fitBounds(overlay_baeume.getBounds());

                var baseMaps = { "OpenStreetMap": osm, "Satellit": satellite };
                var overlays = { "Vegetation": overlay_baeume };
                L.control.layers(baseMaps, overlays, {collapsed: false}).addTo(mymap);
            })
            .catch(err => console.error("Ladefehler:", err));

        // 7. Extras
        L.control.scale({metric: true, imperial: false}).addTo(mymap);
        L.control.ruler().addTo(mymap);

        // 8. Legende mit deinem Namen
        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                categories = ['pot. Bäume', 'pot. Hecken und Büsche', 'pot. Veg'],
                labels = ['Baum', 'Busch/Hecke', 'Wiese'];

            div.innerHTML = '<strong>Legende</strong><br>';

            for (var i = 0; i < categories.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(categories[i]) + '"></i> ' +
                    labels[i] + '<br>';
            }

            // Dein Verweis am Ende der Legende
            div.innerHTML += '<hr style="margin: 8px 0; border: 0; border-top: 1px solid #ccc;">';
            div.innerHTML += '<div style="font-size: 11px; text-align: center; color: #666;">Erstellt von: <b>DEIN NAME</b></div>';

            return div;
        };
        legend.addTo(mymap);
    </script>
</body>
</html>