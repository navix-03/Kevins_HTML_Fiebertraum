<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <title>Vegetation im Seepark, Lahr</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css">
    <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>

    <style>
        html, body, #mapid { width: 100%; height: 100%; padding: 0; margin: 0; }

        .info.legend {
            background: white;
            padding: 12px;
            border: 2px solid #555;
            border-radius: 8px;
            line-height: 24px;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
            color: #333;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
        }

        .info.legend i {
            width: 20px; height: 20px; float: left;
            margin-right: 10px; border: 1px solid #000; opacity: 0.8;
        }

        /* Anpassung für das Mess-Tool Design */
        .leaflet-control-measure { border: 2px solid rgba(0,0,0,0.2); border-radius: 5px; }
    </style>    
</head>
<body>

    <div id="mapid"></div>

    <script>
        // 1. Karte initialisieren
        var mymap = L.map('mapid').setView([48.34, 7.86], 14);

        // 2. Basemaps
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(mymap);

        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        // --- 3. LAYER-STEUERUNG (Zuerst hinzufügen, damit sie oben ist) ---
        var baseMaps = { "OpenStreetMap": osm, "Satellit": satellite };
        var layerControl = L.control.layers(baseMaps, null, {collapsed: false}).addTo(mymap);

        // --- 4. MESS-TOOL (Als zweites hinzufügen, damit es darunter erscheint) ---
        var measureControl = new L.Control.Measure({
            position: 'topright',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares',
            activeColor: '#db4a44',
            completedColor: '#8b2d2a',
            localization: 'de',
            captureZIndex: 10000
        });
        measureControl.addTo(mymap);

        // --- 5. KONFIGURATION (Mapping & Styling) ---
        const namenMapping = {
            "pot. Bäume": "Baum",
            "pot. Hecken und Büsche": "Busch/Hecke",
            "pot. Veg": "Wiese"
        };

        function getColor(d) {
            switch (d) {
                case 'pot. Bäume': return '#00441b';
                case 'pot. Hecken und Büsche': return '#238b45';
                case 'pot. Veg': return '#a1d99b';
                default: return '#bdbdbd';
            }
        }

        function styleFunction(feature) {
            return { 
                fillColor: getColor(feature.properties.Class_name), 
                weight: 1, opacity: 1, color: 'white', fillOpacity: 0.8 
            };
        }

        // --- 6. POPUP FUNKTION MIT MESS-SCHUTZ ---
        function popUpFunction(feature, layer) {
            layer.on('click', function(e) {
                // Prüfen, ob das Mess-Tool gerade aktiv ist (Interaktion läuft)
                var isMeasuring = document.querySelector('.leaflet-measure-interaction') !== null;

                if (!isMeasuring) {
                    let techName = feature.properties.Class_name;
                    let cleanName = namenMapping[techName] || techName;

                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent("<b>Klasse:</b> " + cleanName)
                        .openOn(mymap);
                }
                L.DomEvent.stopPropagation(e);
            });
        }

        // 7. Daten laden
        fetch('Baeume.geojson')
            .then(response => response.json())
            .then(data => {
                var overlay_baeume = L.geoJSON(data, {
                    style: styleFunction,
                    onEachFeature: popUpFunction
                }).addTo(mymap);

                layerControl.addOverlay(overlay_baeume, "Vegetation");
                mymap.fitBounds(overlay_baeume.getBounds());
            });

        L.control.scale({metric: true, imperial: false}).addTo(mymap);

        // 8. Legende
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                categories = ['pot. Bäume', 'pot. Hecken und Büsche', 'pot. Veg'],
                labels = ['Baum', 'Busch/Hecke', 'Wiese'];

            div.innerHTML = '<strong>Legende</strong><br>';
            for (var i = 0; i < categories.length; i++) {
                div.innerHTML += '<i style="background:' + getColor(categories[i]) + '"></i> ' + labels[i] + '<br>';
            }
            div.innerHTML += '<hr style="margin: 8px 0; border: 0; border-top: 1px solid #ccc;">';
            div.innerHTML += '<div style="font-size: 11px; text-align: center; color: #666;">Erstellt von: <b>Kevin Schwabauer</b></div>';
            return div;
        };
        legend.addTo(mymap);
    </script>
</body>
</html>